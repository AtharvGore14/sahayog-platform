{% extends 'base.html' %}

{% block title %}Real-Time Tracking - Sahayog Route Optimizer{% endblock %}

{% block extra_css %}
<style>
    .tracking-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }
    .vehicle-marker {
        width: 30px;
        height: 30px;
        background: #28a745;
        border-radius: 50%;
        border: 3px solid white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        position: absolute;
        transform: translate(-50%, -50%);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.1); }
        100% { transform: translate(-50%, -50%) scale(1); }
    }
    .route-progress {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }
    .status-active { background: #d4edda; color: #155724; }
    .status-completed { background: #cce5ff; color: #004085; }
    .status-delayed { background: #f8d7da; color: #721c24; }
    .map-container {
        height: 500px;
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .vehicle-info {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .pulse {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.1); }
        100% { transform: scale(1); }
    }
    
    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .stat-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .stat-icon {
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover .stat-icon {
        transform: scale(1.1);
    }
    
    .performance-metric {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid #007bff;
    }
    
    .map-container {
        min-height: 500px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Welcome Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info border-0 shadow-sm">
            <div class="d-flex align-items-center">
                <div class="me-3">
                    <i class="fas fa-info-circle fa-2x text-info"></i>
                </div>
                <div>
                    <h5 class="alert-heading mb-1">Welcome to Live Vehicle Tracking!</h5>
                    <p class="mb-0">This page shows real-time locations of all active waste collection vehicles. You can see where each vehicle is, how much of their route they've completed, and get notified when they reach collection points.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Tutorial -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="card-title mb-0">
                    <i class="fas fa-graduation-cap me-2"></i>
                    Quick Tutorial - How to Use This Page
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                <i class="fas fa-map fa-2x text-primary"></i>
                            </div>
                            <h6 class="mb-1">1. View the Map</h6>
                            <p class="small text-muted mb-0">The large map shows all active vehicles as orange pulsing dots. Click any vehicle to see detailed information.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <div class="bg-success bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                <i class="fas fa-truck fa-2x text-success"></i>
                            </div>
                            <h6 class="mb-1">2. Check Vehicle Status</h6>
                            <p class="small text-muted mb-0">The right panel shows each vehicle's progress, estimated completion time, and current status.</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            <div class="bg-warning bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-2" style="width: 60px; height: 60px;">
                                <i class="fas fa-bell fa-2x text-warning"></i>
                            </div>
                            <h6 class="mb-1">3. Monitor Alerts</h6>
                            <p class="small text-muted mb-0">The bottom section shows real-time alerts when vehicles reach collection points or encounter issues.</p>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="hideTutorial()">
                        <i class="fas fa-check me-1"></i>Got it! Hide this tutorial
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Header with Controls -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2">
            <i class="fas fa-satellite-dish me-2 text-primary"></i>
            Live Vehicle Tracking
        </h1>
        <p class="text-muted mb-0">Monitor all active waste collection routes in real-time</p>
    </div>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshTracking()">
                <i class="fas fa-sync-alt me-1"></i>Refresh Now
            </button>
        </div>
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-primary" onclick="toggleAutoRefresh()">
                <i class="fas fa-play me-1" id="autoRefreshIcon"></i>
                <span id="autoRefreshText">Start Auto-Update</span>
            </button>
        </div>
        <div class="btn-group ms-2">
            <button type="button" class="btn btn-sm btn-outline-info" onclick="toggleDebug()">
                <i class="fas fa-bug me-1"></i>Debug
            </button>
        </div>
    </div>
</div>

<!-- Map Section -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="fas fa-map me-2 text-primary"></i>
                        Live Vehicle Tracking Map
                    </h5>
                    <small class="text-muted">Real-time vehicle positions and collection routes</small>
                </div>
                <div class="d-flex align-items-center">
                    <span class="badge bg-success me-2" id="mapStatus">Live</span>
                    <small class="text-muted" id="lastUpdate">Last updated: Just now</small>
                </div>
            </div>
            <div class="card-body p-0 position-relative">
                <!-- Map Legend -->
                <div class="position-absolute top-0 end-0 m-3" style="z-index: 1000;">
                    <div class="card shadow-sm" style="width: 200px;">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-2 small">Map Legend</h6>
                            <div class="d-flex align-items-center mb-1">
                                <div class="me-2" style="width: 20px; height: 20px; background: #ff6b35; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 4px rgba(0,0,0,0.3);"></div>
                                <small>Active Vehicle</small>
                            </div>
                            <div class="d-flex align-items-center mb-1">
                                <div class="me-2" style="width: 16px; height: 16px; background: #28a745; border-radius: 50%; border: 2px solid white;"></div>
                                <small>Collection Point</small>
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="me-2" style="width: 16px; height: 16px; background: #0d6efd; border-radius: 50%; border: 2px solid white;"></div>
                                <small>Route Stop</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="trackingMap" class="map-container">
                    <div class="d-flex align-items-center justify-content-center h-100" id="mapLoading">
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h6 class="text-muted">Loading Live Tracking Map...</h6>
                            <p class="text-muted small">This may take a few seconds</p>
                        </div>
                    </div>
                </div>
                
                <!-- Map Instructions -->
                <div class="position-absolute bottom-0 start-0 m-3" style="z-index: 1000;">
                    <div class="card shadow-sm" style="max-width: 300px;">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-2 small">
                                <i class="fas fa-lightbulb me-1 text-warning"></i>
                                How to Use This Map
                            </h6>
                            <ul class="mb-0 small text-muted">
                                <li>Orange pulsing dots = Active vehicles</li>
                                <li>Click any vehicle to see details</li>
                                <li>Green dots = Collection points</li>
                                <li>Dashed lines = Collection routes</li>
                                <li>Map updates automatically every 5 seconds</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Debug Info (hidden by default) -->
                <div class="position-absolute top-0 start-0 m-3" style="z-index: 1000; display: none;" id="debugPanel">
                    <div class="card shadow-sm" style="max-width: 250px;">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-2 small text-danger">
                                <i class="fas fa-bug me-1"></i>
                                Debug Info
                            </h6>
                            <div class="small text-muted">
                                <div>Vehicles: <span id="debugVehicleCount">0</span></div>
                                <div>Map Ready: <span id="debugMapReady">No</span></div>
                                <div>Data Source: <span id="debugDataSource">Unknown</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Statistics Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-gradient text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>
                            Live System Statistics
                        </h5>
                        <small class="opacity-75">Real-time performance metrics and system status</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2" id="systemStatus">Active</span>
                        <small class="opacity-75" id="statsLastUpdate">Updated: Just now</small>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Main Statistics Row -->
                <div class="row mb-4">
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card border-0 bg-primary bg-opacity-10 h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-route fa-3x text-primary stat-icon"></i>
                                </div>
                                <h3 class="text-primary mb-1" id="activeCount">{{ vehicle_positions|length }}</h3>
                                <p class="text-muted mb-0">Active Routes</p>
                                <small class="text-success">
                                    <i class="fas fa-arrow-up me-1"></i>Live Tracking
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card border-0 bg-success bg-opacity-10 h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-percentage fa-3x text-success stat-icon"></i>
                                </div>
                                <h3 class="text-success mb-1" id="avgProgress">
                                    {% if vehicle_positions %}
                                        {{ vehicle_positions|length|add:"-1"|floatformat:0 }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </h3>
                                <p class="text-muted mb-0">Average Progress</p>
                                <small class="text-info">
                                    <i class="fas fa-clock me-1"></i>Real-time
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card border-0 bg-info bg-opacity-10 h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-truck fa-3x text-info stat-icon"></i>
                                </div>
                                <h3 class="text-info mb-1" id="vehicleCount">{{ vehicle_positions|length }}</h3>
                                <p class="text-muted mb-0">Active Vehicles</p>
                                <small class="text-warning">
                                    <i class="fas fa-satellite me-1"></i>GPS Tracking
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-3 col-md-6 mb-3">
                        <div class="card stat-card border-0 bg-warning bg-opacity-10 h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="fas fa-map-marker-alt fa-3x text-warning stat-icon"></i>
                                </div>
                                <h3 class="text-warning mb-1">5</h3>
                                <p class="text-muted mb-0">Collection Points</p>
                                <small class="text-primary">
                                    <i class="fas fa-location-arrow me-1"></i>Monitored
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Performance Metrics Row -->
                <div class="row">
                    <div class="col-lg-4 mb-3">
                        <div class="card stat-card border-0 performance-metric h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-clock fa-2x text-primary stat-icon"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">System Uptime</h6>
                                        <h5 class="text-primary mb-0">99.9%</h5>
                                        <small class="text-muted">Last 24 hours</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card stat-card border-0 performance-metric h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-bolt fa-2x text-success stat-icon"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">Response Time</h6>
                                        <h5 class="text-success mb-0">45ms</h5>
                                        <small class="text-muted">Average latency</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4 mb-3">
                        <div class="card stat-card border-0 performance-metric h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="flex-shrink-0">
                                        <i class="fas fa-shield-alt fa-2x text-info stat-icon"></i>
                                    </div>
                                    <div class="flex-grow-1 ms-3">
                                        <h6 class="mb-1">System Status</h6>
                                        <h5 class="text-info mb-0">Healthy</h5>
                                        <small class="text-muted">All systems operational</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Vehicle Status Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="fas fa-truck me-2 text-primary"></i>
                        Active Vehicle Details
                    </h5>
                    <small class="text-muted">Individual vehicle status and progress tracking</small>
                </div>
                <span class="badge bg-primary" id="vehicleCount">{{ vehicle_positions|length }}</span>
            </div>
            <div class="card-body">
                <!-- Help Text -->
                <div class="alert alert-light border-0 mb-3">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                        <div>
                            <small class="text-muted">
                                <strong>What you're seeing:</strong><br>
                                • Each card shows a vehicle's current route<br>
                                • Progress bar shows how much is completed<br>
                                • ETA shows estimated time remaining<br>
                                • Green dot means vehicle is actively moving
                            </small>
                        </div>
                    </div>
                </div>
                
                <div id="vehicleList">
                    {% for position in vehicle_positions %}
                    <div class="vehicle-info border rounded p-3 mb-3" data-route-id="{{ position.route_id }}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1 text-primary">{{ position.route_name }}</h6>
                                <small class="text-muted">
                                    <i class="fas fa-truck me-1"></i>{{ position.vehicle }}
                                </small>
                            </div>
                            <span class="status-badge status-{{ position.status }}">
                                <i class="fas fa-circle me-1"></i>{{ position.status|title }}
                            </span>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small class="text-muted">
                                    <i class="fas fa-percentage me-1"></i>Route Progress
                                </small>
                                <small class="text-muted fw-bold">{{ position.progress }}%</small>
                            </div>
                            <div class="route-progress">
                                <div class="progress-bar" style="width: {{ position.progress }}%"></div>
                            </div>
                        </div>
                        
                        {% if position.current_location or position.next_stop %}
                        <div class="mb-2">
                            {% if position.current_location %}
                            <small class="text-muted d-block mb-1">
                                <i class="fas fa-map-marker-alt me-1"></i>Current: <strong>{{ position.current_location }}</strong>
                            </small>
                            {% endif %}
                            {% if position.next_stop %}
                            <small class="text-muted d-block">
                                <i class="fas fa-arrow-right me-1"></i>Next: <strong>{{ position.next_stop }}</strong>
                            </small>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end">
                                    <small class="text-muted d-block">
                                        <i class="fas fa-clock me-1"></i>Time Remaining
                                    </small>
                                    <strong class="small text-info">{{ position.estimated_completion }}</strong>
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">
                                    <i class="fas fa-satellite me-1"></i>Tracking Status
                                </small>
                                <strong class="small text-success">
                                    <i class="fas fa-circle pulse"></i> Live
                                </strong>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted py-5">
                        <div class="mb-3">
                            <i class="fas fa-truck fa-4x text-muted"></i>
                        </div>
                        <h6 class="text-muted">No Active Vehicles</h6>
                        <p class="small text-muted mb-3">
                            There are currently no vehicles on active collection routes. 
                            Vehicles will appear here when they start their assigned routes.
                        </p>
                        <div class="alert alert-info border-0">
                            <small>
                                <i class="fas fa-lightbulb me-1"></i>
                                <strong>Tip:</strong> Go to the Routes page to create and start new collection routes.
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Panel -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bell me-2 text-warning"></i>
                        Live Alerts & Updates
                    </h5>
                    <small class="text-muted">Real-time notifications about vehicle activities</small>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearAllAlerts()">
                    <i class="fas fa-trash me-1"></i>Clear All
                </button>
            </div>
            <div class="card-body">
                <!-- Help Text -->
                <div class="alert alert-light border-0 mb-3">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-info-circle text-info me-2 mt-1"></i>
                        <div>
                            <small class="text-muted">
                                <strong>About these alerts:</strong><br>
                                • You'll see notifications when vehicles reach collection points<br>
                                • Route delays or issues will appear here<br>
                                • System status updates are shown in real-time<br>
                                • Click the X to dismiss individual alerts
                            </small>
                        </div>
                    </div>
                </div>
                
                <div id="alertsList">
                    <div class="alert alert-success alert-dismissible fade show" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>System Status:</strong> All vehicles are operating normally and tracking is active
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Welcome:</strong> Live tracking is now active. You'll see vehicle movements and location updates here.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% if vehicle_positions %}
                    <div class="alert alert-primary alert-dismissible fade show" role="alert">
                        <i class="fas fa-truck me-2"></i>
                        <strong>Active Routes:</strong> {{ vehicle_positions|length }} vehicle(s) are currently on collection routes
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% else %}
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>No Active Routes:</strong> No vehicles are currently on collection routes. Create routes to start tracking.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Empty State -->
                <div id="noAlertsMessage" class="text-center py-4" style="display: none;">
                    <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No Active Alerts</h6>
                    <p class="text-muted small">All systems are running smoothly. New alerts will appear here automatically.</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="vehiclePositionsData">{{ vehicle_positions_json|safe }}</script>
<script>
let map;
let vehicleMarkers = [];
let routeLines = [];
let collectionPointMarkers = [];
let autoRefreshInterval;
let isAutoRefresh = false;

// Vehicle positions data from actual route optimization
let vehiclePositions = [];
let allRouteLocations = []; // Store all route locations for map display

// Load data from Django template
try {
    const dataElement = document.getElementById('vehiclePositionsData');
    if (dataElement && dataElement.textContent) {
        const dataText = dataElement.textContent.trim();
        if (dataText && dataText !== '[]' && dataText !== 'null') {
            vehiclePositions = JSON.parse(dataText);
            console.log('Loaded vehicle positions from route optimization:', vehiclePositions);
            
            // Extract all route locations for map display
            vehiclePositions.forEach(function(position) {
                if (position.route_locations && position.route_locations.length > 0) {
                    allRouteLocations = allRouteLocations.concat(position.route_locations);
                }
            });
        }
    }
} catch (e) {
    console.error('Error parsing vehicle positions data:', e);
}

// Only use sample data if explicitly enabled and no real data exists
{% if use_sample_data and not vehicle_positions %}
const sampleVehiclePositions = [
    {
        route_id: 1,
        route_name: 'Downtown Collection Route',
        vehicle: 'Truck Alpha',
        latitude: 20.5937,
        longitude: 78.9629,
        progress: 45,
        status: 'in_progress',
        estimated_completion: '35 min remaining',
        current_location: 'Central Market Area',
        next_stop: 'City Hall Collection Point',
        route_locations: [
            { id: 1, name: 'Central Market Area', latitude: 20.5937, longitude: 78.9629, visit_order: 1, location_type: 'bin' },
            { id: 2, name: 'City Hall Collection Point', latitude: 20.6037, longitude: 78.9729, visit_order: 2, location_type: 'collection_point' },
            { id: 3, name: 'Shopping Mall Collection Point', latitude: 20.6137, longitude: 78.9829, visit_order: 3, location_type: 'collection_point' }
        ]
    },
    {
        route_id: 2,
        route_name: 'Residential Collection Route',
        vehicle: 'Van Beta',
        latitude: 20.5837,
        longitude: 78.9529,
        progress: 72,
        status: 'in_progress',
        estimated_completion: '18 min remaining',
        current_location: 'Residential Area Bin',
        next_stop: 'University Campus Bin',
        route_locations: [
            { id: 4, name: 'Residential Area Bin', latitude: 20.5837, longitude: 78.9529, visit_order: 1, location_type: 'bin' },
            { id: 5, name: 'University Campus Bin', latitude: 20.5737, longitude: 78.9429, visit_order: 2, location_type: 'bin' },
            { id: 6, name: 'Park Collection Point', latitude: 20.5637, longitude: 78.9329, visit_order: 3, location_type: 'collection_point' }
        ]
    },
    {
        route_id: 3,
        route_name: 'Industrial Zone Route',
        vehicle: 'Compactor Gamma',
        latitude: 20.6137,
        longitude: 78.9829,
        progress: 28,
        status: 'in_progress',
        estimated_completion: '52 min remaining',
        current_location: 'Industrial Zone Bin',
        next_stop: 'Warehouse Collection Point',
        route_locations: [
            { id: 7, name: 'Industrial Zone Bin', latitude: 20.6137, longitude: 78.9829, visit_order: 1, location_type: 'bin' },
            { id: 8, name: 'Warehouse Collection Point', latitude: 20.6237, longitude: 78.9929, visit_order: 2, location_type: 'collection_point' },
            { id: 9, name: 'Factory Area Bin', latitude: 20.6337, longitude: 79.0029, visit_order: 3, location_type: 'bin' }
        ]
    }
];
if (vehiclePositions.length === 0) {
    vehiclePositions = sampleVehiclePositions;
    console.log('Using sample vehicle positions (demo mode):', vehiclePositions);
    
    // Extract all route locations for map display
    vehiclePositions.forEach(function(position) {
        if (position.route_locations && position.route_locations.length > 0) {
            allRouteLocations = allRouteLocations.concat(position.route_locations);
        }
    });
}
{% endif %}

console.log('Final vehicle positions to display:', vehiclePositions);

$(document).ready(function() {
    // Wait for Leaflet to be available
    if (typeof L !== 'undefined') {
        // Small delay to ensure everything is loaded
        setTimeout(function() {
            initializeTrackingMap();
            updateVehiclePositions();
        }, 100);
    } else {
        console.error('Leaflet not loaded');
        // Show error message
        $('#mapLoading').html('<div class="alert alert-danger">Map failed to load. Please refresh the page.</div>');
    }
});

function initializeTrackingMap() {
    try {
        console.log('Initializing map with vehicle positions:', vehiclePositions);
        
        // Hide loading indicator
        $('#mapLoading').hide();
        
        // Determine map center based on actual data
        let mapCenter = [20.5937, 78.9629]; // Default center
        let mapZoom = 11; // Default zoom
        
        if (vehiclePositions.length > 0) {
            // Use first vehicle position as center
            mapCenter = [vehiclePositions[0].latitude, vehiclePositions[0].longitude];
        } else if (allRouteLocations.length > 0) {
            // Use first route location as center
            mapCenter = [allRouteLocations[0].latitude, allRouteLocations[0].longitude];
        }
        
        // Initialize Leaflet map
        map = L.map('trackingMap').setView(mapCenter, mapZoom);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add route lines first (so they appear behind markers)
        addRouteLines();
        
        // Add collection points from actual route data
        addCollectionPoints();
        
        // Add vehicle markers from actual route data
        if (vehiclePositions && vehiclePositions.length > 0) {
            console.log('Adding', vehiclePositions.length, 'vehicle markers from route optimization');
            vehiclePositions.forEach(function(position) {
                addVehicleMarker(position);
            });
            
            // Fit map to show all markers (vehicles + collection points) with padding
            const allMarkers = vehicleMarkers.map(v => v.marker);
            if (allMarkers.length > 0) {
                const group = new L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.2));
            }
        } else {
            console.log('No active routes found. Create and start a route to see live tracking.');
            // Show helpful message if no vehicles
            const infoMessage = L.marker(mapCenter).addTo(map)
                .bindPopup(`
                    <div style="min-width: 200px; text-align: center;">
                        <h6 class="mb-2">No Active Routes</h6>
                        <p class="mb-2 small">Create a route and start live tracking to see vehicles here.</p>
                        <a href="{% url 'route_optimizer:optimize_route' %}" class="btn btn-sm btn-primary">Create Route</a>
                    </div>
                `)
                .openPopup();
        }
        
        console.log('Map initialized successfully with', vehicleMarkers.length, 'vehicles and', collectionPointMarkers.length, 'collection points');
        
        // Update debug info if debug panel is visible
        if (document.getElementById('debugPanel').style.display === 'block') {
            updateDebugInfo();
        }
    } catch (e) {
        console.error('Error initializing map:', e);
        $('#mapLoading').html('<div class="alert alert-warning">Map initialization failed. Please refresh the page.</div>');
    }
}

function addCollectionPoints() {
    // Use actual route locations from route optimization data
    if (allRouteLocations.length > 0) {
        // Group by location to avoid duplicates
        const uniqueLocations = {};
        allRouteLocations.forEach(function(loc) {
            const key = loc.latitude + ',' + loc.longitude;
            if (!uniqueLocations[key]) {
                uniqueLocations[key] = loc;
            }
        });
        
        Object.values(uniqueLocations).forEach(function(location) {
            const collectionIcon = L.divIcon({
                className: 'collection-marker',
                html: '<div style="background:#28a745;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,0.3);"><i class="fas fa-trash" style="font-size:10px;"></i></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            L.marker([location.latitude, location.longitude], { icon: collectionIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="min-width: 150px;">
                        <h6 class="mb-1 text-success">${location.name}</h6>
                        <small class="text-muted">${location.location_type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</small>
                    </div>
                `);
            
            collectionPointMarkers.push([location.latitude, location.longitude]);
        });
    } else {
        // Fallback: Add some default collection points if no route data
        const defaultPoints = [
            { lat: 20.5937, lng: 78.9629, name: 'Default Collection Point' }
    ];
    
        defaultPoints.forEach(function(point) {
        const collectionIcon = L.divIcon({
            className: 'collection-marker',
            html: '<div style="background:#28a745;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;border:2px solid #fff;box-shadow:0 0 4px rgba(0,0,0,0.3);"><i class="fas fa-trash" style="font-size:10px;"></i></div>',
            iconSize: [20, 20],
            iconAnchor: [10, 10]
        });
        
        L.marker([point.lat, point.lng], { icon: collectionIcon })
            .addTo(map)
            .bindPopup(`
                <div style="min-width: 150px;">
                    <h6 class="mb-1 text-success">${point.name}</h6>
                    <small class="text-muted">Collection Point</small>
                </div>
            `);
    });
    }
}

function addRouteLines() {
    // Add route lines from actual route optimization data
    const routeColors = ['#0d6efd', '#dc3545', '#28a745', '#ffc107', '#6f42c1', '#fd7e14'];
    let colorIndex = 0;
    
    vehiclePositions.forEach(function(position) {
        if (position.route_locations && position.route_locations.length > 1) {
            // Sort locations by visit_order
            const sortedLocations = position.route_locations.slice().sort((a, b) => a.visit_order - b.visit_order);
            
            // Create polyline points from route locations
            const routePoints = sortedLocations.map(function(loc) {
                return [loc.latitude, loc.longitude];
            });
            
            // Close the route by returning to start (optional)
            if (routePoints.length > 2) {
                routePoints.push(routePoints[0]);
            }
            
            const routeColor = routeColors[colorIndex % routeColors.length];
            colorIndex++;
            
            const polyline = L.polyline(routePoints, {
                color: routeColor,
            weight: 3,
            opacity: 0.6,
            dashArray: '10, 10'
        }).addTo(map);
            
            routeLines.push(polyline);
        
        // Add route label at the start point
            if (routePoints.length > 0) {
                L.marker(routePoints[0]).addTo(map)
            .bindPopup(`
                        <div style="min-width: 150px;">
                            <h6 class="mb-1 text-primary">${position.route_name}</h6>
                            <small class="text-muted">Vehicle: ${position.vehicle}</small><br>
                            <small class="text-muted">${sortedLocations.length} stops</small>
                </div>
            `)
            .setOpacity(0); // Make invisible, just for popup
            }
        }
    });
    
    // If no routes, don't add any lines
    if (routeLines.length === 0 && vehiclePositions.length === 0) {
        console.log('No route data available to display route lines');
    }
}

function addVehicleMarker(position) {
    try {
        // Create custom truck icon
        const truckIcon = L.divIcon({
            className: 'vehicle-marker',
            html: '<i class="fas fa-truck" style="color: #28a745; font-size: 16px;"></i>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const marker = L.marker([position.latitude, position.longitude], {
            icon: truckIcon
        }).addTo(map);
        
        marker.bindPopup(`
            <div style="min-width: 250px;">
                <div class="text-center mb-2">
                    <h6 class="mb-1 text-primary">${position.route_name}</h6>
                    <small class="text-muted">Live Vehicle Tracking</small>
                </div>
                <hr class="my-2">
                <div class="mb-2">
                    <i class="fas fa-truck text-primary me-2"></i>
                    <strong>Vehicle:</strong> ${position.vehicle}
                </div>
                <div class="mb-2">
                    <i class="fas fa-percentage text-success me-2"></i>
                    <strong>Progress:</strong> ${position.progress}% complete
                </div>
                <div class="mb-2">
                    <i class="fas fa-clock text-info me-2"></i>
                    <strong>ETA:</strong> ${position.estimated_completion}
                </div>
                ${position.current_location ? `
                <div class="mb-2">
                    <i class="fas fa-map-marker-alt text-warning me-2"></i>
                    <strong>Current:</strong> ${position.current_location}
                </div>
                ` : ''}
                ${position.next_stop ? `
                <div class="mb-2">
                    <i class="fas fa-arrow-right text-secondary me-2"></i>
                    <strong>Next:</strong> ${position.next_stop}
                </div>
                ` : ''}
                <div class="text-center mt-2">
                    <span class="badge bg-success">
                        <i class="fas fa-circle pulse me-1"></i>
                        ${position.status.replace('_', ' ')}
                    </span>
                </div>
            </div>
        `);
        
        vehicleMarkers.push({
            marker: marker,
            routeId: position.route_id
        });
    } catch (e) {
        console.error('Error adding vehicle marker:', e);
    }
}

function updateVehiclePositions() {
    // Refresh data from server to get updated positions
    // For now, we'll update progress based on time elapsed
    // In a real implementation, this would fetch from an API endpoint
    
    vehicleMarkers.forEach(function(vehicle) {
        const position = vehiclePositions.find(p => p.route_id === vehicle.routeId);
        if (position && position.route_locations && position.route_locations.length > 0) {
            // Calculate updated progress based on time (simulated movement along route)
            // In production, this would come from GPS/API
            const timeElapsed = 5; // seconds since last update (auto-refresh interval)
            const progressIncrement = (timeElapsed / 60) / (position.route_locations.length * 2); // Rough estimate
            const newProgress = Math.min(100, position.progress + (progressIncrement * 100));
            position.progress = newProgress;
            
            // Recalculate position along route based on new progress
            const totalLocations = position.route_locations.length;
            const current_segment = Math.floor((newProgress / 100) * (totalLocations - 1));
            const segment_progress = ((newProgress / 100) * (totalLocations - 1)) - current_segment;
            
            if (current_segment < totalLocations - 1) {
                const sortedLocs = position.route_locations.slice().sort((a, b) => a.visit_order - b.visit_order);
                const currentLoc = sortedLocs[Math.min(current_segment, totalLocations - 1)];
                const nextLoc = sortedLocs[Math.min(current_segment + 1, totalLocations - 1)];
                
                const newLat = currentLoc.latitude + (nextLoc.latitude - currentLoc.latitude) * segment_progress;
                const newLng = currentLoc.longitude + (nextLoc.longitude - currentLoc.longitude) * segment_progress;
                
                vehicle.marker.setLatLng([newLat, newLng]);
            }
            
            // Update progress bar
            $(`.vehicle-info[data-route-id="${position.route_id}"] .progress-bar`)
                .css('width', newProgress.toFixed(0) + '%');
            $(`.vehicle-info[data-route-id="${position.route_id}"] .text-muted.fw-bold`)
                .text(newProgress.toFixed(0) + '%');
            
            // Update ETA (rough estimate)
            const remainingProgress = 100 - newProgress;
            const estimatedMinutes = Math.max(0, Math.round(remainingProgress * 0.3));
            position.estimated_completion = estimatedMinutes > 0 ? 
                `${estimatedMinutes} min remaining` : 'Completed';
            
            // Update ETA display
            $(`.vehicle-info[data-route-id="${position.route_id}"] .small.text-info`)
                .text(position.estimated_completion);
        }
    });
    
    // Update active count
    const activeCount = vehiclePositions.filter(p => p.progress < 100).length;
    $('#activeCount').text(activeCount);
    
    // Update average progress
    const avgProgress = vehiclePositions.length > 0 ? 
        vehiclePositions.reduce((sum, p) => sum + p.progress, 0) / vehiclePositions.length : 0;
    $('#avgProgress').text(avgProgress.toFixed(0) + '%');
    
    // Update last update time
    updateLastUpdateTime();
}

function showLocationReachedAlert(position) {
    // Add alert to the alerts panel
    const alertHtml = `
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="fas fa-map-marker-alt me-2"></i>
            <strong>Location Update:</strong> ${position.vehicle} has reached a collection point on route "${position.route_name}"
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('#alertsList').prepend(alertHtml);
    
    // Remove old alerts if there are too many
    const alerts = $('#alertsList .alert');
    if (alerts.length > 8) {
        alerts.slice(8).remove();
    }
    
    // Update last update time
    updateLastUpdateTime();
}

function clearAllAlerts() {
    $('#alertsList .alert').remove();
    $('#noAlertsMessage').show();
}

function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    $('#lastUpdate').text(`Last updated: ${timeString}`);
    $('#statsLastUpdate').text(`Updated: ${timeString}`);
}

function hideTutorial() {
    $('.card.border-primary').fadeOut();
}

function toggleDebug() {
    const debugPanel = document.getElementById('debugPanel');
    if (debugPanel.style.display === 'none') {
        debugPanel.style.display = 'block';
        updateDebugInfo();
    } else {
        debugPanel.style.display = 'none';
    }
}

function updateDebugInfo() {
    document.getElementById('debugVehicleCount').textContent = vehiclePositions.length;
    document.getElementById('debugMapReady').textContent = map ? 'Yes' : 'No';
    document.getElementById('debugDataSource').textContent = 
        vehiclePositions.length > 0 ? 'Route Optimization Data' : 'No Active Routes';
}

function refreshTracking() {
    // Reload page to get fresh data from server
    location.reload();
}

function toggleAutoRefresh() {
    if (isAutoRefresh) {
        clearInterval(autoRefreshInterval);
        $('#autoRefreshIcon').removeClass('fa-pause').addClass('fa-play');
        $('#autoRefreshText').text('Auto Refresh');
        isAutoRefresh = false;
    } else {
        autoRefreshInterval = setInterval(updateVehiclePositions, 5000);
        $('#autoRefreshIcon').removeClass('fa-play').addClass('fa-pause');
        $('#autoRefreshText').text('Stop Auto');
        isAutoRefresh = true;
    }
}

// Start auto-refresh by default
$(document).ready(function() {
    toggleAutoRefresh();
});
</script>
{% endblock %}
